---
import PageLayout from '../../layouts/PageLayout.astro';
---

<PageLayout
  title="Recommendations - Ramy Ghorayeb"
  description="My Recommendations for Books, Music, Movies, and Places"
>
  <div class="fade-in">
    <!-- Page Title -->
    <h1 class="text-4xl md:text-5xl font-bold mb-16">Recommendations</h1>

    <!-- Recommendations Content -->
    <section class="max-w-2xl">
      <div class="prose prose-lg max-w-none">

        <!-- Current Reads Section -->
        <div class="mb-16">
          <h2 class="text-2xl font-semibold mb-4" style="color: var(--color-text);">Current Reads</h2>
          <p class="text-sm mb-6" style="color: var(--color-text-secondary);">
            Continuously updated through my Goodreads RSS feed
          </p>

          <!-- Loading State -->
          <div id="books-loading" class="text-lg" style="color: var(--color-text-secondary);">
            Loading books<span id="loading-dots">.</span>
          </div>

          <!-- Error State -->
          <div id="books-error" class="hidden text-lg" style="color: var(--color-text-secondary);">
            Unable to load books. Please try again later.
          </div>

          <!-- Books List -->
          <ul id="books-container" class="hidden list-none space-y-2" style="color: var(--color-text);">
            <!-- Books will be inserted here -->
          </ul>
        </div>

        <script>
          const GOODREADS_USER_ID = '164831396';
          const RSS_URL = `https://www.goodreads.com/review/list_rss/${GOODREADS_USER_ID}?shelf=currently-reading`;

          // Animate loading dots
          let dotCount = 1;
          const dotsInterval = setInterval(() => {
            const dotsEl = document.getElementById('loading-dots');
            if (dotsEl) {
              dotCount = (dotCount % 3) + 1;
              dotsEl.textContent = '.'.repeat(dotCount);
            }
          }, 500);

          async function loadCurrentlyReading() {
            const loadingEl = document.getElementById('books-loading');
            const errorEl = document.getElementById('books-error');
            const containerEl = document.getElementById('books-container');

            try {
              // Use a CORS proxy to fetch the RSS feed
              const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(RSS_URL)}`);
              const data = await response.json();
              const xmlText = data.contents;

              // Parse XML
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

              // Get all book items
              const items = xmlDoc.querySelectorAll('item');

              if (items.length === 0) {
                clearInterval(dotsInterval);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.textContent = 'No books currently reading.';
                return;
              }

              // Clear container
              while (containerEl.firstChild) {
                containerEl.removeChild(containerEl.firstChild);
              }

              // Process each book
              items.forEach(item => {
                const title = item.querySelector('title')?.textContent || 'Unknown Title';
                const link = item.querySelector('link')?.textContent || '#';
                const description = item.querySelector('description')?.textContent || '';
                const pubDate = item.querySelector('pubDate')?.textContent || '';

                // Extract author from description
                const authorMatch = description.match(/author:\s*([^<\n]+)/i);
                const author = authorMatch ? authorMatch[1].trim() : 'Unknown Author';

                // Format date added
                let dateAdded = '';
                if (pubDate) {
                  const date = new Date(pubDate);
                  dateAdded = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                }

                // Create bullet point
                const listItem = document.createElement('li');
                listItem.className = 'text-lg';
                listItem.style.color = 'var(--color-text)';

                // Format: Author - Title (added on Date)
                const bookLink = document.createElement('a');
                bookLink.href = link;
                bookLink.target = '_blank';
                bookLink.rel = 'noopener noreferrer';
                bookLink.className = 'hover:underline';
                bookLink.style.color = 'var(--color-text)';
                bookLink.textContent = `${author} - ${title}`;

                listItem.appendChild(bookLink);

                if (dateAdded) {
                  const dateSpan = document.createElement('span');
                  dateSpan.style.color = 'var(--color-text-secondary)';
                  dateSpan.textContent = ` (added on ${dateAdded})`;
                  listItem.appendChild(dateSpan);
                }

                containerEl.appendChild(listItem);
              });

              // Show list, hide loading
              clearInterval(dotsInterval);
              loadingEl.classList.add('hidden');
              containerEl.classList.remove('hidden');

            } catch (error) {
              console.error('Error loading books:', error);
              clearInterval(dotsInterval);
              loadingEl.classList.add('hidden');
              errorEl.classList.remove('hidden');
            }
          }

          // Load books when page loads
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadCurrentlyReading);
          } else {
            loadCurrentlyReading();
          }
        </script>

        <!-- Google Maps Recommendations Section -->
        <div class="mb-16">
          <h2 class="text-2xl font-semibold mb-8" style="color: var(--color-text);">Recommendations - Google Maps</h2>
          <p class="text-lg" style="color: var(--color-text-secondary);">
            [Content to Be Added]
          </p>
        </div>

        <!-- Best of Everything Section -->
        <div class="mb-16">
          <h2 class="text-2xl font-semibold mb-8" style="color: var(--color-text);">Best Book / Music / Movies / Places (in Squared Pictures)</h2>
          <p class="text-lg" style="color: var(--color-text-secondary);">
            [Content to Be Added]
          </p>
        </div>

      </div>
    </section>
  </div>
</PageLayout>
